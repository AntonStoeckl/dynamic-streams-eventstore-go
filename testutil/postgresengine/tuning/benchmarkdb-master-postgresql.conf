# PostgreSQL 17.5 Benchmark Master Configuration for EventStore High-Throughput Testing
# Optimized for write-heavy event appends with streaming replication (4GB allocation)

# Connection Settings
listen_addresses = '*'                   # Listen on all addresses (required for Docker)
max_connections = 200                    # Reduced from 300 but higher than test
superuser_reserved_connections = 3       # Reserve connections for admin tasks

# Memory Settings (optimized for 7GB write master allocation)
shared_buffers = 1792MB                  # 25% of 7GB allocation (1.75GB)
effective_cache_size = 4200MB            # 60% of 7GB allocation (4.2GB)
work_mem = 96MB                          # Increased for 7GB allocation, balanced for CTEs
maintenance_work_mem = 448MB             # Maintenance operations (6% of 7GB)

# WAL (Write-Ahead Logging) Settings - PostgreSQL 17.5 Enhanced for High Throughput
wal_level = replica                      # Enable streaming replication
wal_buffers = 56MB                       # Increased for 7GB allocation, balanced for high throughput  
max_wal_size = 6GB                       # Increased from 4GB for high-throughput appends
min_wal_size = 1536MB                    # Increased from 1GB (1.5GB)
checkpoint_completion_target = 0.7       # Spread checkpoint I/O (changed from 0.9)
wal_compression = on                     # PostgreSQL 17 improved WAL compression
wal_keep_size = 2GB                      # Keep WAL for replicas

# Autovacuum Settings - Aggressive for High-Write Event Store
autovacuum = on
autovacuum_max_workers = 3               # Increased from 2 (test) but less than original 4
autovacuum_naptime = 30s                 # More frequent than 60s for high writes
autovacuum_vacuum_scale_factor = 0.1     # Vacuum at 10% dead tuples
autovacuum_analyze_scale_factor = 0.05   # Analyze at 5% changed tuples
autovacuum_vacuum_cost_delay = 10ms      # Reduce vacuum delay for performance
autovacuum_vacuum_cost_limit = 2000      # Higher vacuum work rate

# Statistics Settings - High for Accurate Query Planning
default_statistics_target = 1000         # Keep high for better planning
track_counts = on                        # Required for autovacuum
track_functions = all                    # Track function calls
track_activities = on                    # Track query activities
track_io_timing = on                     # Track I/O timing for monitoring

# JSONB and GIN Index Settings - PostgreSQL 17.5 Enhanced
effective_io_concurrency = 200           # Higher for write-optimized SSD
maintenance_io_concurrency = 10          # Maintenance I/O concurrency

# Query Planner Settings - Optimized for Modern Storage
random_page_cost = 1.1                   # SSD-optimized
seq_page_cost = 1.0                      # Sequential read cost
cpu_tuple_cost = 0.01                    # CPU cost per tuple
cpu_index_tuple_cost = 0.005             # CPU cost per index tuple
cpu_operator_cost = 0.0025               # CPU cost per operator

# Replication Settings - PostgreSQL 17.5 Streaming Replication
max_wal_senders = 5                      # Allow up to 5 replicas
max_replication_slots = 5                # Replication slots for failover
wal_sender_timeout = 60s                 # WAL sender timeout
synchronous_standby_names = ''           # Async replication for performance

# Checkpoint Settings - Optimized for Append-Heavy Event Store
checkpoint_timeout = 10min               # More frequent than original 15min for writes
checkpoint_warning = 30s                 # Warn if checkpoints too frequent

# Parallel Processing - PostgreSQL 17.5 Improvements
max_worker_processes = 8                 # Total worker processes
max_parallel_workers_per_gather = 2      # Parallel query workers (moderate for write master)
max_parallel_workers = 8                 # Max parallel workers
max_parallel_maintenance_workers = 2     # Parallel maintenance

# Connection and Lock Settings
deadlock_timeout = 1s                    # Keep standard
lock_timeout = 5s                        # Keep responsive
statement_timeout = 30s                  # Keep responsive for writes

# Background Writer Settings - Optimized for Write Workload
bgwriter_delay = 50ms                    # Keep responsive
bgwriter_lru_maxpages = 1000             # Higher for write workload
bgwriter_lru_multiplier = 10.0           # Aggressive background writing

# PostgreSQL 17.5 Performance Monitoring
pg_stat_statements.track = all           # Track all statements
pg_stat_statements.max = 10000           # Track more statements