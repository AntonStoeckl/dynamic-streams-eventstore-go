## Simulation Architecture Simplification
- **Created**: 2025-08-19 21:35
- **Started**: 2025-08-19 21:35
- **Priority**: High
- **Objective**: Radically simplify simulation architecture by unifying batch processing and auto-tuning into single sequential loop

## ğŸ¯ Core Insight
Since batches already run sequentially (after pile-up fix) and there's no actual state refresh, we can eliminate complex synchronization and create a single main loop with immediate feedback.

## ğŸ“‹ Implementation Plan

### **Phase 1: Create Unified Simulation Loop**
1. **ğŸ”§ Create new `simulation.go`** with unified simulation struct
   - Single main loop replacing scheduler + load controller
   - Direct metrics calculation from batch processing
   - Immediate auto-tuning feedback (1s vs 5s delay)

2. **ğŸ“Š Simplify metrics collection**
   - Keep last 10 batches only (1 second window)  
   - Calculate P50/P99 directly - no complex history
   - Remove all async RecordLatency/RecordTimeout calls

3. **âš¡ Single loop structure**
   ```
   Every 100ms cycle:
   - Rotate active readers
   - Process batch â†’ get metrics
   - Record metrics
   
   Every 1s (10 cycles):
   - Calculate P50/P99
   - Auto-tune reader count
   
   Every 500ms (5 cycles):
   - Process librarians
   
   Immediate when needed:
   - Adjust reader population
   ```

### **Phase 2: Remove Unnecessary Components**
1. **âŒ Delete these goroutines:**
   - `refreshState()` - doesn't actually refresh (ShouldRefresh always false)
   - `verifyLibrarianState()` - already disabled (expensive query)
   - `LoadController` - entire component becomes inline
   - `managePopulation()` goroutine - make immediate

2. **ğŸ§¹ Eliminate synchronization**
   - No mutexes between components
   - No channels between scheduler/controller
   - Direct access to metrics

### **Phase 3: File Structure Cleanup**
1. **ğŸ“ New structure:**
   ```
   simulation2/
   â”œâ”€â”€ main.go           (update to use UnifiedSimulation)
   â”œâ”€â”€ simulation.go     (NEW - unified loop)  
   â”œâ”€â”€ actors.go         (unchanged)
   â”œâ”€â”€ handlers.go       (unchanged)
   â”œâ”€â”€ state.go          (remove ShouldRefresh)
   â”œâ”€â”€ tuning.go         (merge all constants)
   â””â”€â”€ [DELETE] scheduler.go, load_controller.go
   ```

## ğŸ“ˆ Expected Improvements

| Component | Before | After | Benefit |
|-----------|--------|-------|---------|
| **Goroutines** | 7+ | 1 | -85% complexity |
| **Mutex locks** | ~10/batch | 0 | No synchronization! |
| **Auto-tune delay** | 5 seconds | 1 second | 5x faster |
| **Code files** | 5 | 3 | -40% files |
| **Lines of code** | ~2000 | ~600 | -70% reduction |
| **Mental model** | Complex async | Simple loop | Much clearer |

## ğŸ”§ Implementation Strategy
1. Create new `simulation.go` alongside existing code
2. Test new implementation thoroughly  
3. Switch `main.go` to use new simulation
4. Delete old scheduler.go and load_controller.go
5. Clean up unused code

## ğŸš¨ Risk Mitigation
- Keep old files initially for easy rollback
- Extensive logging during transition
- Side-by-side comparison of metrics

## âœ… Success Criteria
- âœ… Single main loop handles all processing
- âœ… 1-second auto-tuning response (vs 5s currently)
- âœ… No goroutine synchronization issues
- âœ… Same simulation behavior and performance
- âœ… Dramatically simplified codebase