## Query Handler Observable Wrapper Implementation Plan
- **Created**: 2025-08-29 16:45
- **Started**: 2025-09-14 18:30
- **Completed**: 2025-09-15 19:45
- **Priority**: High
- **Objective**: Implement observable wrapper for query handlers with minimal metadata pattern

## 🎯 Problem & Solution

**Problem**: Query handlers had inline observability mixed with business logic (unlike command handlers which use clean wrapper pattern).

**Solution**: Clean separation of concerns using composition pattern:
- **Core Handler**: Pure business logic only (no observability)
- **Snapshot Wrapper**: Performance optimization (observability-free)
- **Observable Wrapper**: Complete observability instrumentation

**Architecture**: `Core Handler → Snapshot Wrapper → Observable Wrapper`

## 📋 Implementation Progress

### Phase 1: Snapshot Wrapper Cleanup ✅ COMPLETED
1. ✅ **Remove ALL component metrics** from snapshot wrapper:
   - ✅ Delete `recordComponentTiming()` method
   - ✅ Remove ALL component timing calls (11 total)
   - ✅ Remove ALL metrics recording (no internal metrics either)
   - ✅ Remove metricsCollector field from struct
2. ✅ **Clean up Grafana dashboard** (`library-example-dashboard.json`):
   - ✅ Remove the snapshot save duration panel entirely (id: 16)  
   - ✅ Remove snapshot hit rate panel (id: 14)
   - ✅ Remove snapshot miss rate panel (id: 15)
3. ✅ **Simplify snapshot wrapper**:
   - ✅ Remove ALL metrics dependencies
   - ✅ Keep only logging for debugging
   - ✅ Remove unused parameters while preserving context for logging
4. ✅ **Clean up constants** in `observability.go`:
   - ✅ Remove ALL `Component*` constants (6 total)
   - ✅ Remove `QueryHandlerComponentDurationMetric` constant
5. ✅ **Fix linting issues** and method signatures
6. ✅ **Skip failing snapshot tests** temporarily during refactoring
   - ✅ Added t.Skip() to 21 test functions across 7 test files
   - 🔔 **REMINDER**: Re-enable/fix skipped snapshot tests after observable wrapper implementation is complete

### Phase 2: Proof of Concept - DETAILED IMPLEMENTATION PLAN

**Implementation Order (User-Refined Approach):**

#### Step 1: Create Observable Query Wrapper ✅ COMPLETED
- ✅ **New file**: `example/shared/shell/observable/query_wrapper.go`
- ✅ **Type**: `QueryWrapper[Q shell.Query, R shell.QueryResult]`
- ✅ **Purpose**: Wraps any `CoreQueryHandler[Q, R]` interface (clean handlers without Expose* methods)
- ✅ **Features**:
  - ✅ Adds ALL observability (metrics, tracing, logging) around wrapped handler
  - ✅ Has independent Options (WithQueryMetrics, WithQueryTracing, WithQueryContextualLogging, WithQueryLogging)
  - ✅ Similar to CommandWrapper pattern but for queries
  - ✅ No metadata needed - wrapper has everything from timing and errors
- ✅ **Testing**: Created `query_wrapper_test.go` with mock handlers using existing spy infrastructure
- ✅ **Options Independence**: Fixed both CommandWrapper and QueryWrapper to have independent option systems
  - ✅ **CommandWrapper**: Uses `CommandOption[C]` with `WithCommandXXX[C]` functions
  - ✅ **QueryWrapper**: Uses `QueryOption[Q, R]` with `WithQueryXXX[Q, R]` functions
  - ✅ **Removed**: `configuresObservability` interface abstraction
  - ✅ **Simplified**: Direct pointer-based functional options
  - ✅ **Updated**: All tests to use new option system
  - ✅ **Fixed**: simulation2/handlers.go with 6 specific command option builders

#### Step 2: Create QueryWrapper (observability-free) ✅ COMPLETED
- ✅ **New file**: `example/shared/shell/snapshot/query_wrapper.go`
- ✅ **Type**: `QueryWrapper[Q shell.Query, R shell.QueryResult]` (renamed from SnapshotWrapper)
- ✅ **Constructor**: `NewQueryWrapper()` (renamed from NewSnapshotWrapper)
- ✅ **Based on**: `GenericSnapshotWrapper` but completely observability-free:
  - ✅ **Removed ALL observability**: No logging, metrics, tracing, or functional options
  - ✅ **Removed useless methods**: `recordSnapshotSaveError()`, `logSnapshotHit()` that did nothing
  - ✅ **Pure snapshot logic**: Only loading, saving, incremental updates, fallback
  - ✅ **Compatible interface**: Extracts EventStore via `ExposeEventStore()` from base handler
- ✅ **Purpose**: Pure snapshot logic only, zero observability artifacts
- ✅ **Strategy**: Coexists with `GenericSnapshotWrapper` during migration
- ✅ **Error handling improvements**:
  - ✅ **Fail-fast approach**: No more error swallowing except for snapshot miss (normal case)
  - ✅ **Removed fallback pattern**: Deleted repetitive `fallbackToCoreHandler()` calls
  - ✅ **Descriptive error messages**: All errors include context (load, query, unmarshal, deserialize, save)
  - ✅ **Snapshot save errors**: Now fail the query instead of silent swallowing
  - ✅ **Consistent error handling**: Same approach throughout the wrapper
- ✅ **Interface cleanup**:
  - ✅ **Removed anti-pattern method**: Deleted `BuildSnapshotType()` that existed only for tests
  - ✅ **Clean wrapper interface**: Only contains essential business methods
  - ✅ **Better test patterns**: Tests use `query.SnapshotType()` directly, no wrapper dependency
- ✅ **Testing**: Updated BooksInCirculation snapshot tests to use new `QueryWrapper`
  - ✅ **Removed t.Skip()** from 3 BooksInCirculation snapshot tests
  - ✅ **Updated test setup** to use `snapshot.NewQueryWrapper`
  - ✅ **Removed metric assertions** (no observability in new wrapper)
  - ✅ **Proper test refactoring**: Tests use domain objects directly, no test-only wrapper methods
  - ✅ **All tests pass**: Snapshot miss, creation/hit, incremental updates work correctly
- ✅ **Naming rationale**: `QueryWrapper` matches filename and clearly indicates query-specific wrapper

**🔔 IMPORTANT LESSONS LEARNED**:
- **Never create methods that exist only for testing** - tests should work with domain objects directly
- **Fail fast on all real errors** - only fall back for normal business conditions (like snapshot miss)
- **Error visibility is crucial** - silent error swallowing makes debugging impossible
- **Clean interfaces** - wrappers should only contain essential business methods

#### Step 3: Clean BooksInCirculation Query Handler ✅ COMPLETED
- ✅ **File**: `example/features/query/booksincirculation/query_handler.go`
- ✅ **Removed**:
  - ALL observability fields (metricsCollector, tracingCollector, contextualLogger, logger)
  - ALL Options (WithMetrics, WithTracing, WithContextualLogging, WithLogging)
  - ALL helper methods (recordQuerySuccess, recordQueryError, recordQueryCancelled, recordQueryTimeout)
  - ALL Expose* methods (no longer needed with Option 3 approach)
  - Error return from NewQueryHandler
- ✅ **Kept**: ONLY business logic - pure handler with just eventStore field and Handle method

#### Step 4: Fix Tests & Integration ✅ COMPLETED
- ✅ **Updated `query_handler_test.go`**:
  - ✅ Updated construction (no error return from NewQueryHandler)
  - ✅ **Applied code style improvements following codestyle.md**:
    - ✅ Added `t.Helper()` to all test helper functions
    - ✅ Wrapped long function signatures properly
    - ✅ Improved comments structure (setup/arrange/act/assert pattern)
    - ✅ Better variable naming (testBookIDs, testReaderIDs)
    - ✅ Consistent test organization and readability improvements

- ✅ **Updated `query_wrapper_test.go` (snapshot tests)**:
  - ✅ Removed ALL metrics-related code from all 3 snapshot tests
  - ✅ Updated to use new `snapshot.QueryWrapper` with separate EventStore parameter
  - ✅ Tests now focus purely on snapshot functionality without observability noise
  - ✅ Proper test structure with setup/arrange/act/assert comments

- ✅ **Updated snapshot wrapper implementation**:
  - ✅ **Option 3 approach**: Pass EventStore separately to `NewQueryWrapper`
  - ✅ Changed signature to accept `shell.CoreQueryHandler[Q, R]` and `QueriesEventsAndHandlesSnapshots`
  - ✅ Simplified constructor - no type checking needed (caller responsibility)
  - ✅ Clean handler no longer needs ExposeEventStore method

**🎯 IMPORTANT TEST STYLE IMPROVEMENTS TO APPLY TO OTHER QUERY HANDLERS**:
- **Add `t.Helper()`** to all test helper functions
- **Wrap long function signatures** according to codestyle.md (>130 chars, >2 params)
- **Use setup/arrange/act/assert comment structure** consistently
- **Improve variable naming** with descriptive types (testBookIDs vs testBooks)
- **Consistent test organization** and readability patterns
- **Remove verbose comments**, keep essential ones only

#### Step 5: Fix Simulation Integration ✅ COMPLETED
- ✅ **Updated simulation2/handlers.go**:
  - ✅ **New composition pattern**: `Core Handler → Snapshot Wrapper → Observable Wrapper`
  - ✅ **Clean handler creation**: `booksincirculation.NewQueryHandler(eventStore)` (no error, no options)
  - ✅ **New snapshot wrapper**: `snapshot.NewQueryWrapper(coreHandler, eventStore, ...)` with separate EventStore parameter
  - ✅ **Observable wrapper**: `observable.NewQueryWrapper(snapshotHandler, options...)` with query-specific options
  - ✅ **New options builder**: `buildBooksInCirculationQueryOptions()` for `observable.QueryWrapper`
  - ✅ **Updated HandlerBundle type**: Changed from `*snapshot.GenericSnapshotWrapper` to `*observable.QueryWrapper`

- ✅ **Updated cmd/cleanup/main.go**:
  - ✅ **Same composition pattern** applied to cleanup tool
  - ✅ **Added observable import** and new options builder function
  - ✅ **Full compatibility** with new architecture

**Final Architecture for BooksInCirculation**:
```go
// Core Handler (clean, business logic only)
coreHandler := booksincirculation.NewQueryHandler(eventStore)

// Snapshot Wrapper (performance optimization)
snapshotHandler := snapshot.NewQueryWrapper(coreHandler, eventStore, ...)

// Observable Wrapper (observability instrumentation)
observableHandler := observable.NewQueryWrapper(snapshotHandler, options...)
```

**🎉 SUCCESS**: All linting passes ✅ - BooksInCirculation is now the first query handler using the new clean architecture!

### Phase 3: Rollout to Remaining 6 Query Handlers (READY TO IMPLEMENT)

**🎯 Pattern to Apply**: Follow exact same steps as BooksInCirculation for consistency.

#### 📋 **6.1 BooksLentByReader Query Handler** ✅ COMPLETED
- ✅ **a) Update query handler** (`example/features/query/bookslentbyreader/query_handler.go`):
  - ✅ Remove ALL observability fields, options, helper methods, Expose* methods
  - ✅ Keep ONLY business logic with clean `NewQueryHandler(eventStore)` signature
- ✅ **b) Update query handler test** (`bookslentbyreader/query_handler_test.go`):
  - ✅ Apply test style improvements: `t.Helper()`, proper wrapping, setup/arrange/act/assert, descriptive naming
  - ✅ Update construction (no error return)
- ✅ **c) Update snapshot test** (`bookslentbyreader/query_handler_snapshot_test.go`):
  - ✅ Remove ALL metrics code, use new `snapshot.QueryWrapper` with separate EventStore parameter
  - ✅ Remove t.Skip() from 3 bookslentbyreader snapshot tests - all now passing
- ✅ **d) Update simulation integration**:
  - ✅ Update `simulation2/handlers.go`: New composition pattern Core→Snapshot→Observable
  - ✅ Create `buildBooksLentByReaderQueryOptions()` for observable wrapper
  - ✅ Update HandlerBundle type to use `*observable.QueryWrapper`

**🎉 SUCCESS**: BooksLentByReader now uses clean architecture! All tests passing ✅

### 🔧 **Additional Improvements Made**

#### ✅ **Options Duplication Elimination** (2025-09-15)
- **Problem**: All `build*Options()` functions in `simulation2/handlers.go` were nearly identical (8 functions × 15 lines = ~120 lines of duplication)
- **Solution**: Created 2 generic builder functions using Go generics:
  - `buildCommandOptions[C shell.Command](obsConfig)` - Generic command options builder
  - `buildQueryOptions[Q shell.Query, R shell.QueryResult](obsConfig)` - Generic query options builder
- **Results**:
  - ✅ **Reduced ~120 lines to 32 lines** (2 generic functions) + 8 one-liners
  - ✅ **Single source of truth** for all observability logic
  - ✅ **Type-safe generics** with proper interface constraints
  - ✅ **Maintained full API compatibility** - no breaking changes
  - ✅ **All tests pass** and simulation builds successfully

**Before**: 8 duplicated functions × 15 lines each = ~120 lines
**After**: 2 generic functions (32 lines) + 8 one-liners = ~48 lines total
**Net Reduction**: ~72 lines of eliminated duplication

#### 📋 **6.2 BooksLentOut Query Handler** ✅ COMPLETED
- ✅ **a) Update query handler** (`example/features/query/bookslentout/query_handler.go`):
  - ✅ Remove ALL observability fields, options, helper methods, Expose* methods
  - ✅ Keep ONLY business logic with clean `NewQueryHandler(eventStore)` signature
- ✅ **b) Update query handler test** (`bookslentout/query_handler_test.go`):
  - ✅ Apply test style improvements: `t.Helper()`, proper wrapping, setup/arrange/act/assert, descriptive naming
  - ✅ Update construction (no error return)
  - ✅ Rename test structs: `testBooks` → `testBookIDs`, `testReaders` → `testReaderIDs`
  - ✅ Update field names to match pattern (book1ID, book2ID, etc.)
  - ✅ Move test data creation to arrange section, remove superfluous comments
- ✅ **c) Update snapshot test** (`bookslentout/query_handler_snapshot_test.go`):
  - ✅ Remove ALL t.Skip() calls and metrics code
  - ✅ Update to use new `snapshot.QueryWrapper` with separate EventStore parameter
  - ✅ Use `query.SnapshotType()` directly instead of wrapper method
- ✅ **d) Update simulation integration**:
  - ✅ Update `simulation2/handlers.go`: New composition pattern Core→Snapshot→Observable
  - ✅ Update HandlerBundle type to use `*observable.QueryWrapper`
  - ✅ Remove `buildBooksLentOutOptions()` function (use generic `buildQueryOptions`)
  - ✅ Update `cmd/cleanup/main.go`: Apply same composition pattern

**🎉 SUCCESS**: BooksLentOut now uses clean architecture! All tests passing ✅

**🔧 Additional Cleanup**: Applied same generic options pattern to cleanup/main.go:
- ✅ **Added generic `buildQueryOptions` function** for observable query wrappers
- ✅ **Replaced 2 duplicated functions** with calls to generic function
- ✅ **Reduced code duplication** by 12 lines (33% reduction)
- ✅ **Future-proofed** for when remaining handlers get migrated
- ✅ **Cleanup tool builds successfully**

#### 📋 **6.3 RegisteredReaders Query Handler** ✅ COMPLETED
- ✅ **a) Update query handler** (`example/features/query/registeredreaders/query_handler.go`):
  - ✅ Remove ALL observability fields, options, helper methods, Expose* methods
  - ✅ Keep ONLY business logic with clean `NewQueryHandler(eventStore)` signature
- ✅ **b) Update query handler test** (`registeredreaders/query_handler_test.go`):
  - ✅ Apply test style improvements: `t.Helper()`, proper wrapping, setup/arrange/act/assert, descriptive naming
  - ✅ Update construction (no error return)
  - ✅ Rename test structs: `testReaders` → `testReaderIDs`
  - ✅ Update field names to match pattern (reader1ID, reader2ID, etc.)
  - ✅ Move test data creation to arrange section, remove superfluous comments
- ✅ **c) Update snapshot test** (`registeredreaders/query_handler_snapshot_test.go`):
  - ✅ Remove ALL t.Skip() calls and metrics code
  - ✅ Update to use new `snapshot.QueryWrapper` with separate EventStore parameter
  - ✅ Use `query.SnapshotType()` directly instead of wrapper method
- ✅ **d) Update simulation integration**:
  - ✅ Update `simulation2/handlers.go`: New composition pattern Core→Snapshot→Observable
  - ✅ Update HandlerBundle type to use `*observable.QueryWrapper`
  - ✅ Remove `buildRegisteredReadersOptions()` function (use generic `buildQueryOptions`)
  - ✅ Update `cmd/cleanup/main.go`: Apply same composition pattern

**🎉 SUCCESS**: RegisteredReaders now uses clean architecture! All tests passing ✅

#### 📋 **6.4 CanceledReaders Query Handler** ✅ COMPLETED
- ✅ **a) Update query handler** (`example/features/query/canceledreaders/query_handler.go`):
  - ✅ Remove ALL observability fields, options, helper methods, Expose* methods
  - ✅ Keep ONLY business logic with clean `NewQueryHandler(eventStore)` signature
- ✅ **b) Update query handler test** (`canceledreaders/query_handler_test.go`):
  - ✅ Apply test style improvements: `t.Helper()`, proper wrapping, setup/arrange/act/assert, descriptive naming
  - ✅ Update construction (no error return)
  - ✅ Rename test structs: `testReaders` → `testReaderIDs`
  - ✅ Update field names to match pattern (reader1ID, reader2ID, etc.)
  - ✅ Move test data creation to arrange section, remove superfluous comments
- ✅ **c) Update snapshot test** (`canceledreaders/query_handler_snapshot_test.go`):
  - ✅ Remove ALL t.Skip() calls and metrics code
  - ✅ Update to use new `snapshot.QueryWrapper` with separate EventStore parameter
  - ✅ Use `query.SnapshotType()` directly instead of wrapper method
- ✅ **d) Update simulation integration**:
  - ✅ Update `cmd/cleanup/main.go`: New composition pattern Core→Snapshot→Observable
  - ✅ Remove `buildCanceledReadersOptions()` function (use generic `buildQueryOptions`)

**🎉 SUCCESS**: CanceledReaders now uses clean architecture! All tests passing ✅

#### 📋 **6.5 FinishedLendings Query Handler** ✅ COMPLETED
- ✅ **a) Update query handler** (`example/features/query/finishedlendings/query_handler.go`):
  - ✅ Remove ALL observability fields, options, helper methods, Expose* methods
  - ✅ Keep ONLY business logic with clean `NewQueryHandler(eventStore)` signature
- ✅ **b) Update query handler test** (`finishedlendings/query_handler_test.go`):
  - ✅ Apply test style improvements: `t.Helper()`, proper wrapping, setup/arrange/act/assert, descriptive naming
  - ✅ Update construction (no error return)
  - ✅ Rename test structs: `testEntities` → `testEntityIDs`
  - ✅ Update field names to match pattern (book1ID, reader1ID, etc.)
  - ✅ Move test data creation to arrange section, remove superfluous comments
- ✅ **c) Update snapshot test** (`finishedlendings/query_handler_snapshot_test.go`):
  - ✅ Remove ALL t.Skip() calls and metrics code
  - ✅ Update to use new `snapshot.QueryWrapper` with separate EventStore parameter
  - ✅ Use `query.SnapshotType()` directly instead of wrapper method
  - ✅ Remove all metrics-related helper functions
- ✅ **d) Update simulation integration** (cleanup tool only - not used in main simulation):
  - ✅ Update `cmd/cleanup/main.go`: New composition pattern Core→Snapshot→Observable
  - ✅ Remove `buildFinishedLendingsOptions()` function (use generic `buildQueryOptions`)

**🎉 SUCCESS**: FinishedLendings now uses clean architecture! All tests passing ✅

#### 📋 **6.6 RemovedBooks Query Handler** ✅ COMPLETED
- ✅ **a) Update query handler** (`example/features/query/removedbooks/query_handler.go`):
  - ✅ Remove ALL observability fields, options, helper methods, Expose* methods
  - ✅ Keep ONLY business logic with clean `NewQueryHandler(eventStore)` signature
- ✅ **b) Update query handler test** (`removedbooks/query_handler_test.go`):
  - ✅ Apply test style improvements: `t.Helper()`, proper wrapping, setup/arrange/act/assert, descriptive naming
  - ✅ Update construction (no error return)
  - ✅ Rename test structs: `testBooks` → `testBookIDs`
  - ✅ Update field names to match pattern (book1ID, book2ID, etc.)
  - ✅ Move test data creation to arrange section, remove superfluous comments
- ✅ **c) Update snapshot test** (`removedbooks/query_handler_snapshot_test.go`):
  - ✅ Remove ALL t.Skip() calls and metrics code
  - ✅ Update to use new `snapshot.QueryWrapper` with separate EventStore parameter
  - ✅ Use `query.SnapshotType()` directly instead of wrapper method
  - ✅ Remove all metrics-related helper functions
- ✅ **d) Update simulation integration** (cleanup tool only - not used in main simulation):
  - ✅ Update `cmd/cleanup/main.go`: New composition pattern Core→Snapshot→Observable
  - ✅ Remove `buildRemovedBooksOptions()` function (use generic `buildQueryOptions`)

**🎉 SUCCESS**: RemovedBooks now uses clean architecture! All tests passing ✅

**🎯 MILESTONE ACHIEVED**: All 6 query handlers (6.1-6.6) have been successfully migrated to the clean architecture pattern!

## 📊 Final Summary

### ✅ **IMPLEMENTATION COMPLETED**
- **Total Query Handlers Migrated**: 6 handlers (6.1-6.6)
- **Architecture Pattern**: Core Handler → Snapshot Wrapper → Observable Wrapper
- **Code Reduction**: ~70+ lines eliminated through generic options pattern
- **Test Coverage**: All tests passing ✅
- **Build Status**: All tools building successfully ✅

### 🏗️ **Architecture Achievements**
1. **Clean Separation of Concerns**: Business logic completely separated from observability
2. **Consistent Pattern**: All handlers follow identical composition pattern
3. **Type Safety**: Generic wrappers with proper interface constraints
4. **Performance**: Snapshot optimization layer preserved without observability coupling
5. **Maintainability**: Single source of truth for observability logic

### 🧪 **Quality Assurance**
- **Test Style Consistency**: All test files follow codestyle.md patterns (`t.Helper()`, proper naming, setup/arrange/act/assert)
- **Code Duplication Eliminated**: Generic options builders replace ~120 lines of duplicated code
- **Error Handling Improved**: Fail-fast approach in snapshot wrappers with descriptive error messages
- **Interface Cleanup**: Removed anti-pattern methods and test-only dependencies

### 🚀 **Migration Complete**
All query handlers now use the **clean architecture pattern** with complete observability separation:

1. **BooksInCirculation** (6.1) ✅
2. **BooksLentByReader** (6.2) ✅
3. **BooksLentOut** (6.3) ✅
4. **RegisteredReaders** (6.4) ✅
5. **CanceledReaders** (6.5) ✅
6. **FinishedLendings** (6.6) ✅
7. **RemovedBooks** (6.7) ✅

**🎉 TASK COMPLETED SUCCESSFULLY** - Ready for production use!