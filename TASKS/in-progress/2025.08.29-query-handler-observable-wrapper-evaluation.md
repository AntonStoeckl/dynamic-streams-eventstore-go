## Query Handler Observable Wrapper Implementation Plan
- **Created**: 2025-08-29 16:45
- **Started**: 2025-09-14 18:30
- **Completed**: 2025-09-15 19:45
- **Priority**: High
- **Objective**: Implement observable wrapper for query handlers with minimal metadata pattern

## ğŸ¯ Problem & Solution

**Problem**: Query handlers had inline observability mixed with business logic (unlike command handlers which use clean wrapper pattern).

**Solution**: Clean separation of concerns using composition pattern:
- **Core Handler**: Pure business logic only (no observability)
- **Snapshot Wrapper**: Performance optimization (observability-free)
- **Observable Wrapper**: Complete observability instrumentation

**Architecture**: `Core Handler â†’ Snapshot Wrapper â†’ Observable Wrapper`

## ğŸ“‹ Implementation Progress

### Phase 1: Snapshot Wrapper Cleanup âœ… COMPLETED
1. âœ… **Remove ALL component metrics** from snapshot wrapper:
   - âœ… Delete `recordComponentTiming()` method
   - âœ… Remove ALL component timing calls (11 total)
   - âœ… Remove ALL metrics recording (no internal metrics either)
   - âœ… Remove metricsCollector field from struct
2. âœ… **Clean up Grafana dashboard** (`library-example-dashboard.json`):
   - âœ… Remove the snapshot save duration panel entirely (id: 16)  
   - âœ… Remove snapshot hit rate panel (id: 14)
   - âœ… Remove snapshot miss rate panel (id: 15)
3. âœ… **Simplify snapshot wrapper**:
   - âœ… Remove ALL metrics dependencies
   - âœ… Keep only logging for debugging
   - âœ… Remove unused parameters while preserving context for logging
4. âœ… **Clean up constants** in `observability.go`:
   - âœ… Remove ALL `Component*` constants (6 total)
   - âœ… Remove `QueryHandlerComponentDurationMetric` constant
5. âœ… **Fix linting issues** and method signatures
6. âœ… **Skip failing snapshot tests** temporarily during refactoring
   - âœ… Added t.Skip() to 21 test functions across 7 test files
   - ğŸ”” **REMINDER**: Re-enable/fix skipped snapshot tests after observable wrapper implementation is complete

### Phase 2: Proof of Concept - DETAILED IMPLEMENTATION PLAN

**Implementation Order (User-Refined Approach):**

#### Step 1: Create Observable Query Wrapper âœ… COMPLETED
- âœ… **New file**: `example/shared/shell/observable/query_wrapper.go`
- âœ… **Type**: `QueryWrapper[Q shell.Query, R shell.QueryResult]`
- âœ… **Purpose**: Wraps any `CoreQueryHandler[Q, R]` interface (clean handlers without Expose* methods)
- âœ… **Features**:
  - âœ… Adds ALL observability (metrics, tracing, logging) around wrapped handler
  - âœ… Has independent Options (WithQueryMetrics, WithQueryTracing, WithQueryContextualLogging, WithQueryLogging)
  - âœ… Similar to CommandWrapper pattern but for queries
  - âœ… No metadata needed - wrapper has everything from timing and errors
- âœ… **Testing**: Created `query_wrapper_test.go` with mock handlers using existing spy infrastructure
- âœ… **Options Independence**: Fixed both CommandWrapper and QueryWrapper to have independent option systems
  - âœ… **CommandWrapper**: Uses `CommandOption[C]` with `WithCommandXXX[C]` functions
  - âœ… **QueryWrapper**: Uses `QueryOption[Q, R]` with `WithQueryXXX[Q, R]` functions
  - âœ… **Removed**: `configuresObservability` interface abstraction
  - âœ… **Simplified**: Direct pointer-based functional options
  - âœ… **Updated**: All tests to use new option system
  - âœ… **Fixed**: simulation2/handlers.go with 6 specific command option builders

#### Step 2: Create QueryWrapper (observability-free) âœ… COMPLETED
- âœ… **New file**: `example/shared/shell/snapshot/query_wrapper.go`
- âœ… **Type**: `QueryWrapper[Q shell.Query, R shell.QueryResult]` (renamed from SnapshotWrapper)
- âœ… **Constructor**: `NewQueryWrapper()` (renamed from NewSnapshotWrapper)
- âœ… **Based on**: `GenericSnapshotWrapper` but completely observability-free:
  - âœ… **Removed ALL observability**: No logging, metrics, tracing, or functional options
  - âœ… **Removed useless methods**: `recordSnapshotSaveError()`, `logSnapshotHit()` that did nothing
  - âœ… **Pure snapshot logic**: Only loading, saving, incremental updates, fallback
  - âœ… **Compatible interface**: Extracts EventStore via `ExposeEventStore()` from base handler
- âœ… **Purpose**: Pure snapshot logic only, zero observability artifacts
- âœ… **Strategy**: Coexists with `GenericSnapshotWrapper` during migration
- âœ… **Error handling improvements**:
  - âœ… **Fail-fast approach**: No more error swallowing except for snapshot miss (normal case)
  - âœ… **Removed fallback pattern**: Deleted repetitive `fallbackToCoreHandler()` calls
  - âœ… **Descriptive error messages**: All errors include context (load, query, unmarshal, deserialize, save)
  - âœ… **Snapshot save errors**: Now fail the query instead of silent swallowing
  - âœ… **Consistent error handling**: Same approach throughout the wrapper
- âœ… **Interface cleanup**:
  - âœ… **Removed anti-pattern method**: Deleted `BuildSnapshotType()` that existed only for tests
  - âœ… **Clean wrapper interface**: Only contains essential business methods
  - âœ… **Better test patterns**: Tests use `query.SnapshotType()` directly, no wrapper dependency
- âœ… **Testing**: Updated BooksInCirculation snapshot tests to use new `QueryWrapper`
  - âœ… **Removed t.Skip()** from 3 BooksInCirculation snapshot tests
  - âœ… **Updated test setup** to use `snapshot.NewQueryWrapper`
  - âœ… **Removed metric assertions** (no observability in new wrapper)
  - âœ… **Proper test refactoring**: Tests use domain objects directly, no test-only wrapper methods
  - âœ… **All tests pass**: Snapshot miss, creation/hit, incremental updates work correctly
- âœ… **Naming rationale**: `QueryWrapper` matches filename and clearly indicates query-specific wrapper

**ğŸ”” IMPORTANT LESSONS LEARNED**:
- **Never create methods that exist only for testing** - tests should work with domain objects directly
- **Fail fast on all real errors** - only fall back for normal business conditions (like snapshot miss)
- **Error visibility is crucial** - silent error swallowing makes debugging impossible
- **Clean interfaces** - wrappers should only contain essential business methods

#### Step 3: Clean BooksInCirculation Query Handler âœ… COMPLETED
- âœ… **File**: `example/features/query/booksincirculation/query_handler.go`
- âœ… **Removed**:
  - ALL observability fields (metricsCollector, tracingCollector, contextualLogger, logger)
  - ALL Options (WithMetrics, WithTracing, WithContextualLogging, WithLogging)
  - ALL helper methods (recordQuerySuccess, recordQueryError, recordQueryCancelled, recordQueryTimeout)
  - ALL Expose* methods (no longer needed with Option 3 approach)
  - Error return from NewQueryHandler
- âœ… **Kept**: ONLY business logic - pure handler with just eventStore field and Handle method

#### Step 4: Fix Tests & Integration âœ… COMPLETED
- âœ… **Updated `query_handler_test.go`**:
  - âœ… Updated construction (no error return from NewQueryHandler)
  - âœ… **Applied code style improvements following codestyle.md**:
    - âœ… Added `t.Helper()` to all test helper functions
    - âœ… Wrapped long function signatures properly
    - âœ… Improved comments structure (setup/arrange/act/assert pattern)
    - âœ… Better variable naming (testBookIDs, testReaderIDs)
    - âœ… Consistent test organization and readability improvements

- âœ… **Updated `query_wrapper_test.go` (snapshot tests)**:
  - âœ… Removed ALL metrics-related code from all 3 snapshot tests
  - âœ… Updated to use new `snapshot.QueryWrapper` with separate EventStore parameter
  - âœ… Tests now focus purely on snapshot functionality without observability noise
  - âœ… Proper test structure with setup/arrange/act/assert comments

- âœ… **Updated snapshot wrapper implementation**:
  - âœ… **Option 3 approach**: Pass EventStore separately to `NewQueryWrapper`
  - âœ… Changed signature to accept `shell.CoreQueryHandler[Q, R]` and `QueriesEventsAndHandlesSnapshots`
  - âœ… Simplified constructor - no type checking needed (caller responsibility)
  - âœ… Clean handler no longer needs ExposeEventStore method

**ğŸ¯ IMPORTANT TEST STYLE IMPROVEMENTS TO APPLY TO OTHER QUERY HANDLERS**:
- **Add `t.Helper()`** to all test helper functions
- **Wrap long function signatures** according to codestyle.md (>130 chars, >2 params)
- **Use setup/arrange/act/assert comment structure** consistently
- **Improve variable naming** with descriptive types (testBookIDs vs testBooks)
- **Consistent test organization** and readability patterns
- **Remove verbose comments**, keep essential ones only

#### Step 5: Fix Simulation Integration âœ… COMPLETED
- âœ… **Updated simulation2/handlers.go**:
  - âœ… **New composition pattern**: `Core Handler â†’ Snapshot Wrapper â†’ Observable Wrapper`
  - âœ… **Clean handler creation**: `booksincirculation.NewQueryHandler(eventStore)` (no error, no options)
  - âœ… **New snapshot wrapper**: `snapshot.NewQueryWrapper(coreHandler, eventStore, ...)` with separate EventStore parameter
  - âœ… **Observable wrapper**: `observable.NewQueryWrapper(snapshotHandler, options...)` with query-specific options
  - âœ… **New options builder**: `buildBooksInCirculationQueryOptions()` for `observable.QueryWrapper`
  - âœ… **Updated HandlerBundle type**: Changed from `*snapshot.GenericSnapshotWrapper` to `*observable.QueryWrapper`

- âœ… **Updated cmd/cleanup/main.go**:
  - âœ… **Same composition pattern** applied to cleanup tool
  - âœ… **Added observable import** and new options builder function
  - âœ… **Full compatibility** with new architecture

**Final Architecture for BooksInCirculation**:
```go
// Core Handler (clean, business logic only)
coreHandler := booksincirculation.NewQueryHandler(eventStore)

// Snapshot Wrapper (performance optimization)
snapshotHandler := snapshot.NewQueryWrapper(coreHandler, eventStore, ...)

// Observable Wrapper (observability instrumentation)
observableHandler := observable.NewQueryWrapper(snapshotHandler, options...)
```

**ğŸ‰ SUCCESS**: All linting passes âœ… - BooksInCirculation is now the first query handler using the new clean architecture!

### Phase 3: Rollout to Remaining 6 Query Handlers (READY TO IMPLEMENT)

**ğŸ¯ Pattern to Apply**: Follow exact same steps as BooksInCirculation for consistency.

#### ğŸ“‹ **6.1 BooksLentByReader Query Handler** âœ… COMPLETED
- âœ… **a) Update query handler** (`example/features/query/bookslentbyreader/query_handler.go`):
  - âœ… Remove ALL observability fields, options, helper methods, Expose* methods
  - âœ… Keep ONLY business logic with clean `NewQueryHandler(eventStore)` signature
- âœ… **b) Update query handler test** (`bookslentbyreader/query_handler_test.go`):
  - âœ… Apply test style improvements: `t.Helper()`, proper wrapping, setup/arrange/act/assert, descriptive naming
  - âœ… Update construction (no error return)
- âœ… **c) Update snapshot test** (`bookslentbyreader/query_handler_snapshot_test.go`):
  - âœ… Remove ALL metrics code, use new `snapshot.QueryWrapper` with separate EventStore parameter
  - âœ… Remove t.Skip() from 3 bookslentbyreader snapshot tests - all now passing
- âœ… **d) Update simulation integration**:
  - âœ… Update `simulation2/handlers.go`: New composition pattern Coreâ†’Snapshotâ†’Observable
  - âœ… Create `buildBooksLentByReaderQueryOptions()` for observable wrapper
  - âœ… Update HandlerBundle type to use `*observable.QueryWrapper`

**ğŸ‰ SUCCESS**: BooksLentByReader now uses clean architecture! All tests passing âœ…

### ğŸ”§ **Additional Improvements Made**

#### âœ… **Options Duplication Elimination** (2025-09-15)
- **Problem**: All `build*Options()` functions in `simulation2/handlers.go` were nearly identical (8 functions Ã— 15 lines = ~120 lines of duplication)
- **Solution**: Created 2 generic builder functions using Go generics:
  - `buildCommandOptions[C shell.Command](obsConfig)` - Generic command options builder
  - `buildQueryOptions[Q shell.Query, R shell.QueryResult](obsConfig)` - Generic query options builder
- **Results**:
  - âœ… **Reduced ~120 lines to 32 lines** (2 generic functions) + 8 one-liners
  - âœ… **Single source of truth** for all observability logic
  - âœ… **Type-safe generics** with proper interface constraints
  - âœ… **Maintained full API compatibility** - no breaking changes
  - âœ… **All tests pass** and simulation builds successfully

**Before**: 8 duplicated functions Ã— 15 lines each = ~120 lines
**After**: 2 generic functions (32 lines) + 8 one-liners = ~48 lines total
**Net Reduction**: ~72 lines of eliminated duplication

#### ğŸ“‹ **6.2 BooksLentOut Query Handler** âœ… COMPLETED
- âœ… **a) Update query handler** (`example/features/query/bookslentout/query_handler.go`):
  - âœ… Remove ALL observability fields, options, helper methods, Expose* methods
  - âœ… Keep ONLY business logic with clean `NewQueryHandler(eventStore)` signature
- âœ… **b) Update query handler test** (`bookslentout/query_handler_test.go`):
  - âœ… Apply test style improvements: `t.Helper()`, proper wrapping, setup/arrange/act/assert, descriptive naming
  - âœ… Update construction (no error return)
  - âœ… Rename test structs: `testBooks` â†’ `testBookIDs`, `testReaders` â†’ `testReaderIDs`
  - âœ… Update field names to match pattern (book1ID, book2ID, etc.)
  - âœ… Move test data creation to arrange section, remove superfluous comments
- âœ… **c) Update snapshot test** (`bookslentout/query_handler_snapshot_test.go`):
  - âœ… Remove ALL t.Skip() calls and metrics code
  - âœ… Update to use new `snapshot.QueryWrapper` with separate EventStore parameter
  - âœ… Use `query.SnapshotType()` directly instead of wrapper method
- âœ… **d) Update simulation integration**:
  - âœ… Update `simulation2/handlers.go`: New composition pattern Coreâ†’Snapshotâ†’Observable
  - âœ… Update HandlerBundle type to use `*observable.QueryWrapper`
  - âœ… Remove `buildBooksLentOutOptions()` function (use generic `buildQueryOptions`)
  - âœ… Update `cmd/cleanup/main.go`: Apply same composition pattern

**ğŸ‰ SUCCESS**: BooksLentOut now uses clean architecture! All tests passing âœ…

**ğŸ”§ Additional Cleanup**: Applied same generic options pattern to cleanup/main.go:
- âœ… **Added generic `buildQueryOptions` function** for observable query wrappers
- âœ… **Replaced 2 duplicated functions** with calls to generic function
- âœ… **Reduced code duplication** by 12 lines (33% reduction)
- âœ… **Future-proofed** for when remaining handlers get migrated
- âœ… **Cleanup tool builds successfully**

#### ğŸ“‹ **6.3 RegisteredReaders Query Handler** âœ… COMPLETED
- âœ… **a) Update query handler** (`example/features/query/registeredreaders/query_handler.go`):
  - âœ… Remove ALL observability fields, options, helper methods, Expose* methods
  - âœ… Keep ONLY business logic with clean `NewQueryHandler(eventStore)` signature
- âœ… **b) Update query handler test** (`registeredreaders/query_handler_test.go`):
  - âœ… Apply test style improvements: `t.Helper()`, proper wrapping, setup/arrange/act/assert, descriptive naming
  - âœ… Update construction (no error return)
  - âœ… Rename test structs: `testReaders` â†’ `testReaderIDs`
  - âœ… Update field names to match pattern (reader1ID, reader2ID, etc.)
  - âœ… Move test data creation to arrange section, remove superfluous comments
- âœ… **c) Update snapshot test** (`registeredreaders/query_handler_snapshot_test.go`):
  - âœ… Remove ALL t.Skip() calls and metrics code
  - âœ… Update to use new `snapshot.QueryWrapper` with separate EventStore parameter
  - âœ… Use `query.SnapshotType()` directly instead of wrapper method
- âœ… **d) Update simulation integration**:
  - âœ… Update `simulation2/handlers.go`: New composition pattern Coreâ†’Snapshotâ†’Observable
  - âœ… Update HandlerBundle type to use `*observable.QueryWrapper`
  - âœ… Remove `buildRegisteredReadersOptions()` function (use generic `buildQueryOptions`)
  - âœ… Update `cmd/cleanup/main.go`: Apply same composition pattern

**ğŸ‰ SUCCESS**: RegisteredReaders now uses clean architecture! All tests passing âœ…

#### ğŸ“‹ **6.4 CanceledReaders Query Handler** âœ… COMPLETED
- âœ… **a) Update query handler** (`example/features/query/canceledreaders/query_handler.go`):
  - âœ… Remove ALL observability fields, options, helper methods, Expose* methods
  - âœ… Keep ONLY business logic with clean `NewQueryHandler(eventStore)` signature
- âœ… **b) Update query handler test** (`canceledreaders/query_handler_test.go`):
  - âœ… Apply test style improvements: `t.Helper()`, proper wrapping, setup/arrange/act/assert, descriptive naming
  - âœ… Update construction (no error return)
  - âœ… Rename test structs: `testReaders` â†’ `testReaderIDs`
  - âœ… Update field names to match pattern (reader1ID, reader2ID, etc.)
  - âœ… Move test data creation to arrange section, remove superfluous comments
- âœ… **c) Update snapshot test** (`canceledreaders/query_handler_snapshot_test.go`):
  - âœ… Remove ALL t.Skip() calls and metrics code
  - âœ… Update to use new `snapshot.QueryWrapper` with separate EventStore parameter
  - âœ… Use `query.SnapshotType()` directly instead of wrapper method
- âœ… **d) Update simulation integration**:
  - âœ… Update `cmd/cleanup/main.go`: New composition pattern Coreâ†’Snapshotâ†’Observable
  - âœ… Remove `buildCanceledReadersOptions()` function (use generic `buildQueryOptions`)

**ğŸ‰ SUCCESS**: CanceledReaders now uses clean architecture! All tests passing âœ…

#### ğŸ“‹ **6.5 FinishedLendings Query Handler** âœ… COMPLETED
- âœ… **a) Update query handler** (`example/features/query/finishedlendings/query_handler.go`):
  - âœ… Remove ALL observability fields, options, helper methods, Expose* methods
  - âœ… Keep ONLY business logic with clean `NewQueryHandler(eventStore)` signature
- âœ… **b) Update query handler test** (`finishedlendings/query_handler_test.go`):
  - âœ… Apply test style improvements: `t.Helper()`, proper wrapping, setup/arrange/act/assert, descriptive naming
  - âœ… Update construction (no error return)
  - âœ… Rename test structs: `testEntities` â†’ `testEntityIDs`
  - âœ… Update field names to match pattern (book1ID, reader1ID, etc.)
  - âœ… Move test data creation to arrange section, remove superfluous comments
- âœ… **c) Update snapshot test** (`finishedlendings/query_handler_snapshot_test.go`):
  - âœ… Remove ALL t.Skip() calls and metrics code
  - âœ… Update to use new `snapshot.QueryWrapper` with separate EventStore parameter
  - âœ… Use `query.SnapshotType()` directly instead of wrapper method
  - âœ… Remove all metrics-related helper functions
- âœ… **d) Update simulation integration** (cleanup tool only - not used in main simulation):
  - âœ… Update `cmd/cleanup/main.go`: New composition pattern Coreâ†’Snapshotâ†’Observable
  - âœ… Remove `buildFinishedLendingsOptions()` function (use generic `buildQueryOptions`)

**ğŸ‰ SUCCESS**: FinishedLendings now uses clean architecture! All tests passing âœ…

#### ğŸ“‹ **6.6 RemovedBooks Query Handler** âœ… COMPLETED
- âœ… **a) Update query handler** (`example/features/query/removedbooks/query_handler.go`):
  - âœ… Remove ALL observability fields, options, helper methods, Expose* methods
  - âœ… Keep ONLY business logic with clean `NewQueryHandler(eventStore)` signature
- âœ… **b) Update query handler test** (`removedbooks/query_handler_test.go`):
  - âœ… Apply test style improvements: `t.Helper()`, proper wrapping, setup/arrange/act/assert, descriptive naming
  - âœ… Update construction (no error return)
  - âœ… Rename test structs: `testBooks` â†’ `testBookIDs`
  - âœ… Update field names to match pattern (book1ID, book2ID, etc.)
  - âœ… Move test data creation to arrange section, remove superfluous comments
- âœ… **c) Update snapshot test** (`removedbooks/query_handler_snapshot_test.go`):
  - âœ… Remove ALL t.Skip() calls and metrics code
  - âœ… Update to use new `snapshot.QueryWrapper` with separate EventStore parameter
  - âœ… Use `query.SnapshotType()` directly instead of wrapper method
  - âœ… Remove all metrics-related helper functions
- âœ… **d) Update simulation integration** (cleanup tool only - not used in main simulation):
  - âœ… Update `cmd/cleanup/main.go`: New composition pattern Coreâ†’Snapshotâ†’Observable
  - âœ… Remove `buildRemovedBooksOptions()` function (use generic `buildQueryOptions`)

**ğŸ‰ SUCCESS**: RemovedBooks now uses clean architecture! All tests passing âœ…

**ğŸ¯ MILESTONE ACHIEVED**: All 6 query handlers (6.1-6.6) have been successfully migrated to the clean architecture pattern!

## ğŸ“Š Final Summary

### âœ… **IMPLEMENTATION COMPLETED**
- **Total Query Handlers Migrated**: 6 handlers (6.1-6.6)
- **Architecture Pattern**: Core Handler â†’ Snapshot Wrapper â†’ Observable Wrapper
- **Code Reduction**: ~70+ lines eliminated through generic options pattern
- **Test Coverage**: All tests passing âœ…
- **Build Status**: All tools building successfully âœ…

### ğŸ—ï¸ **Architecture Achievements**
1. **Clean Separation of Concerns**: Business logic completely separated from observability
2. **Consistent Pattern**: All handlers follow identical composition pattern
3. **Type Safety**: Generic wrappers with proper interface constraints
4. **Performance**: Snapshot optimization layer preserved without observability coupling
5. **Maintainability**: Single source of truth for observability logic

### ğŸ§ª **Quality Assurance**
- **Test Style Consistency**: All test files follow codestyle.md patterns (`t.Helper()`, proper naming, setup/arrange/act/assert)
- **Code Duplication Eliminated**: Generic options builders replace ~120 lines of duplicated code
- **Error Handling Improved**: Fail-fast approach in snapshot wrappers with descriptive error messages
- **Interface Cleanup**: Removed anti-pattern methods and test-only dependencies

### ğŸš€ **Migration Complete**
All query handlers now use the **clean architecture pattern** with complete observability separation:

1. **BooksInCirculation** (6.1) âœ…
2. **BooksLentByReader** (6.2) âœ…
3. **BooksLentOut** (6.3) âœ…
4. **RegisteredReaders** (6.4) âœ…
5. **CanceledReaders** (6.5) âœ…
6. **FinishedLendings** (6.6) âœ…
7. **RemovedBooks** (6.7) âœ…

**ğŸ‰ TASK COMPLETED SUCCESSFULLY** - Ready for production use!