## Add Metrics to EventStore Snapshots
- **Created**: 2025-09-14 10:45
- **Priority**: Medium
- **Objective**: Add proper instrumentation to EventStore snapshot operations (SaveSnapshot/LoadSnapshot)

## üéØ Problem

The EventStore's `SaveSnapshot` and `LoadSnapshot` methods only log operations but don't record any metrics, unlike `Query` and `Append` which have full instrumentation with:
- `setupQueryInstrumentation` / `setupAppendInstrumentation`
- Metrics recording (duration, errors, etc.)
- Tracing spans
- Contextual logging

This inconsistency means snapshot operations lack observability.

## üìê Solution

Add proper instrumentation to snapshot operations following the same pattern as Query/Append:

### 1. Create Snapshot Instrumentation Types

```go
// snapshotSaveInstrumentation encapsulates instrumentation for save operations
type snapshotSaveInstrumentation struct {
    start   time.Time
    span    TracingSpan
    metrics *snapshotSaveMetricsObserver
}

// snapshotLoadInstrumentation encapsulates instrumentation for load operations  
type snapshotLoadInstrumentation struct {
    start   time.Time
    span    TracingSpan
    metrics *snapshotLoadMetricsObserver
}
```

### 2. Add Setup Methods

```go
func (es *EventStore) setupSnapshotSaveInstrumentation(
    ctx context.Context,
    projectionType string,
) (snapshotSaveInstrumentation, context.Context) {
    // Similar to setupQueryInstrumentation
}

func (es *EventStore) setupSnapshotLoadInstrumentation(
    ctx context.Context,
    projectionType string,
) (snapshotLoadInstrumentation, context.Context) {
    // Similar to setupQueryInstrumentation
}
```

### 3. Add Metrics Recording

```go
// In SaveSnapshot
inst, ctx := es.setupSnapshotSaveInstrumentation(ctx, snapshot.ProjectionType)
// ... execute save ...
es.completeSnapshotSaveSuccess(ctx, snapshot, duration, inst)

// In LoadSnapshot  
inst, ctx := es.setupSnapshotLoadInstrumentation(ctx, projectionType)
// ... execute load ...
es.completeSnapshotLoadSuccess(ctx, snapshot, duration, inst)
```

### 4. Metrics to Record

**Save Metrics:**
- `eventstore_snapshot_save_duration_seconds{projection_type="..."}`
- `eventstore_snapshot_save_errors_total{projection_type="...", error_type="..."}`
- `eventstore_snapshot_save_total{projection_type="...", status="success/error"}`

**Load Metrics:**
- `eventstore_snapshot_load_duration_seconds{projection_type="...", result="hit/miss"}`
- `eventstore_snapshot_load_errors_total{projection_type="...", error_type="..."}`
- `eventstore_snapshot_load_total{projection_type="...", result="hit/miss/error"}`

## üìã Implementation Steps

1. **Add instrumentation types** in `eventstore/postgresengine/observability.go`
2. **Create setup methods** for snapshot instrumentation
3. **Update SaveSnapshot** to use instrumentation
4. **Update LoadSnapshot** to use instrumentation  
5. **Add completion methods** for success/error cases
6. **Test metrics recording** with test collector
7. **Update Grafana dashboards** to use new EventStore metrics

## ‚úÖ Benefits

- **Consistency**: All EventStore operations have uniform instrumentation
- **Better observability**: Snapshot operations properly tracked
- **Clean separation**: Metrics at the right layer (EventStore, not wrapper)
- **Future-proof**: Ready for distributed tracing of snapshots

## üìä Testing

- Verify metrics are recorded for successful saves/loads
- Test error metric recording  
- Check snapshot hit/miss differentiation in load metrics
- Validate projection_type labels are correct