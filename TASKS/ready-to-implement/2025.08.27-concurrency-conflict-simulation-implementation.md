## Concurrency Conflict Simulation Implementation
- **Created**: 2025-08-27 11:09
- **Priority**: Low
- **Objective**: Add ability to trigger optimistic concurrency conflicts for EventStore stress testing

## ğŸ¯ Problem Statement
The current simulation with 3 workers provides good concurrency but rarely triggers optimistic concurrency conflicts. We need controlled conflict generation to test:
- EventStore's conflict resolution mechanisms
- Retry logic and failure handling under high contention
- System behavior during database-level concurrency conflicts

## ğŸ“‹ Implementation Plan

### **Phase 1: Conflict Generation Strategies**
1. **âš¡ High-Contention Scenarios**
   - Multiple readers attempting same book simultaneously
   - Parallel operations on same reader account
   - Concurrent librarian operations on same books

2. **ğŸ¯ Targeted Conflict Injection**
   - Identify high-conflict operations (popular books)
   - Coordinate operations to maximize collision probability
   - Time-based conflict windows

### **Phase 2: Configuration and Control**
1. **ğŸ”§ Tuning Constants**
   - `ConcurrencyConflictProbability` - Base chance to trigger conflicts
   - `ConflictIntensityMode` - Low/Medium/High contention levels
   - `ConflictWindowMs` - Time window for coordinated operations

2. **ğŸ“Š Conflict Tracking**
   - Add `ConcurrencyConflictCount` to BatchMetrics
   - Track conflict rates and retry patterns
   - Display in performance logging (`conflicts=X.X%`)

### **Phase 3: Implementation Approaches**
1. **ğŸ­ Actor Coordination**
   - Readers target same popular books within time windows
   - Librarians perform operations on overlapping book sets
   - Coordinated timing for maximum collision potential

2. **âš™ï¸ Worker Pool Modifications**
   - Optional "conflict mode" with higher worker count
   - Coordinated operation timing across workers
   - Burst patterns to create contention spikes

## ğŸš¨ Success Criteria
- âœ… Configurable concurrency conflict rates
- âœ… EventStore handles conflicts gracefully with retries
- âœ… System performance under high-contention scenarios
- âœ… Conflict metrics tracking and display
- âœ… No data corruption under conflict conditions
- âœ… Realistic high-load testing scenarios

## ğŸ”§ Technical Considerations
- **Optional Feature**: This is lower priority than business errors
- **EventStore Testing**: Primarily tests PostgreSQL CTE conflict handling
- **Performance Impact**: May reduce overall throughput during conflict testing
- **Monitoring**: Requires careful observation of retry patterns and failure modes

## ğŸ’¡ Alternative Approaches
- **Worker Count Scaling**: Temporarily increase workers to create conflicts
- **Popular Book Targeting**: Focus operations on small subset of books
- **Time-Synchronized Bursts**: Coordinate operations within narrow time windows