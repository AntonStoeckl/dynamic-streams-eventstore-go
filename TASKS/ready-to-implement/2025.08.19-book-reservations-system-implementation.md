## Extend Example Feature Set with Book Reservations
- **Created**: 2025-08-19 04:45
- **Priority**: Medium  
- **Objective**: Add book reservation/holds system to demonstrate advanced EventStore patterns and realistic library workflows

## Problem Description

Current example domain only demonstrates basic lending workflows. Real libraries have sophisticated reservation systems, hold queues, and automated workflows that would showcase more advanced EventStore capabilities and provide richer simulation scenarios.

## Solution Overview

Implement a comprehensive book reservation system as a new domain feature, demonstrating advanced event sourcing patterns while adding realistic library behavior.

### Core Features
- **Book holds/reservations**: Readers can reserve unavailable books
- **Hold queues**: Multiple readers can queue for popular books  
- **Automatic notifications**: When reserved books become available
- **Hold expiration**: Time limits on unclaimed reservations
- **Priority systems**: First-come-first-served hold fulfillment

## Implementation Plan

### Phase 1: Domain Events & Commands

#### New Domain Events
Create in `example/shared/core/`:
```go
// BookReservedByReader - Reader places hold on unavailable book
type BookReservedByReader struct {
    BookID          uuid.UUID
    ReaderID        uuid.UUID  
    ReservationTime time.Time
    QueuePosition   int
}

// BookReservationCanceled - Reader or system cancels reservation
type BookReservationCanceled struct {
    BookID          uuid.UUID
    ReaderID        uuid.UUID
    CancelationTime time.Time
    Reason          string // "reader_cancel", "expired", "admin_cancel"
}

// BookReservationFulfilled - Reserved book becomes available to reader
type BookReservationFulfilled struct {
    BookID          uuid.UUID
    ReaderID        uuid.UUID
    FulfillmentTime time.Time
    ExpiresAt       time.Time // Time limit to claim book
}

// BookReservationExpired - Reader didn't claim fulfilled reservation
type BookReservationExpired struct {
    BookID          uuid.UUID
    ReaderID        uuid.UUID
    ExpirationTime  time.Time
}
```

#### New Command Handlers
Create in `example/features/command/`:

1. **`reservebook/`** - Place book reservation
   ```go
   type Command struct {
       BookID   uuid.UUID
       ReaderID uuid.UUID
       Time     time.Time
   }
   
   // Business rules:
   // - Book must exist and be in circulation
   // - Reader must be registered and not canceled
   // - Reader cannot have duplicate reservation for same book
   // - Book must be currently unavailable (lent out)
   ```

2. **`cancelreservation/`** - Cancel book reservation
   ```go  
   type Command struct {
       BookID   uuid.UUID
       ReaderID uuid.UUID
       Reason   string
       Time     time.Time
   }
   ```

3. **`fulfillreservation/`** - Auto-fulfill when book available
   ```go
   // Called automatically when reserved book is returned
   type Command struct {
       BookID          uuid.UUID
       ReaderID        uuid.UUID
       FulfillmentTime time.Time
   }
   ```

### Phase 2: Query Handlers

Create in `example/features/query/`:

1. **`bookreservations/`** - Show hold queue for book
   ```go
   type BookReservations struct {
       BookID string
       Holds  []ReservationInfo
   }
   
   type ReservationInfo struct {
       ReaderID        string
       ReservationTime time.Time
       QueuePosition   int
       Status          string // "waiting", "fulfilled", "expired"
   }
   ```

2. **`readerreservations/`** - Show reader's active holds
   ```go
   type ReaderReservations struct {
       ReaderID     string
       ActiveHolds  []ActiveReservation
       History      []ReservationHistory
   }
   ```

### Phase 3: Enhanced Workflows

#### Integration with Existing Commands
1. **Modify `returnbookcopyfromreader`**:
   - After successful return, check for reservations
   - Auto-fulfill first reservation in queue
   - Generate `BookReservationFulfilled` event

2. **Modify `lendbookcopytoreader`**:  
   - Handle fulfilled reservations (reader claims reserved book)
   - Validate reader has valid reservation if book was reserved

#### Simulation Actor Enhancements
1. **ReaderActor reservation behavior**:
   ```go
   // New decision method
   func (r *ReaderActor) ShouldReserveBook() bool {
       // 10% chance to make reservation when visiting library
       // Higher chance if reader has been looking for specific books
   }
   
   func (r *ReaderActor) ShouldClaimReservation() bool {
       // 95% chance to claim fulfilled reservation
       // 5% chance reservation expires (realistic user behavior)
   }
   ```

2. **LibrarianActor cleanup behavior**:
   ```go
   func (l *LibrarianActor) CleanupExpiredReservations() {
       // Periodic cleanup of unclaimed fulfilled reservations
       // Generate BookReservationExpired events
   }
   ```

### Phase 4: Configuration & Tuning

Add to `tuning.go`:
```go
// Reservation system configuration
ReservationExpirationHours = 48    // Time to claim fulfilled reservation
MaxReservationsPerReader   = 3     // Limit concurrent reservations
ReservationCleanupInterval = 24 * time.Hour

// Reader behavior probabilities  
ChanceReserveBook         = 0.10   // 10% chance per library visit
ChanceClaimReservation    = 0.95   // 95% chance to claim fulfilled reservation
```

## Technical Implementation Details

### Files to Create
```
example/features/command/reservebook/
├── command.go
├── command_handler.go  
├── decide.go
└── command_handler_test.go

example/features/command/cancelreservation/
├── command.go
├── command_handler.go
├── decide.go  
└── command_handler_test.go

example/features/query/bookreservations/
├── query.go
├── query_handler.go
├── project.go
└── query_handler_test.go

example/features/query/readerreservations/
├── query.go
├── query_handler.go  
├── project.go
└── query_handler_test.go
```

### Files to Modify
- `example/shared/core/` - Add new domain events
- `example/features/command/returnbookcopyfromreader/decide.go` - Reservation fulfillment
- `example/features/command/lendbookcopytoreader/decide.go` - Reserved book claiming
- `example/simulation2/actors.go` - Reader/librarian reservation behavior
- `example/simulation2/handlers.go` - New command/query handlers integration

### Database Schema Considerations
- Reservations are event-sourced (no schema changes needed)
- Query handlers build reservation state from events
- Consider event stream performance with high reservation volume

## Advanced EventStore Patterns Demonstrated

### Multi-Aggregate Coordination
- Book availability affects reservation fulfillment
- Reader actions impact book reservation queues
- Cross-aggregate business rules validation

### Time-Based Event Processing  
- Reservation expiration handling
- Automatic fulfillment workflows
- Cleanup of expired reservations

### Queue Management via Event Sourcing
- First-in-first-out reservation queues
- Queue position calculation from event history
- Automatic queue reordering on cancellations

## Success Criteria

### Functional Requirements
- ✅ Readers can reserve books that are currently unavailable
- ✅ Multiple readers can queue for the same book (FIFO ordering)
- ✅ Automatic reservation fulfillment when book becomes available
- ✅ Reservation expiration and cleanup (48-hour claim window)
- ✅ Comprehensive business rule validation for all edge cases

### Technical Requirements  
- ✅ All reservation functionality implemented via event sourcing
- ✅ No database schema changes (pure event-driven)
- ✅ Full test coverage for all command and query handlers
- ✅ Integration with existing simulation actor behavior
- ✅ Performance testing with high reservation volumes

### Simulation Integration
- ✅ Realistic reader reservation behavior (10% chance per visit)
- ✅ Librarian cleanup of expired reservations
- ✅ Enhanced simulation metrics including reservation statistics
- ✅ Grafana dashboards showing reservation queue lengths and fulfillment rates

## Benefits & Impact

### EventStore Showcase
- Demonstrates advanced event sourcing patterns
- Shows complex business workflows via events
- Validates EventStore performance under realistic library load

### Simulation Realism  
- Much more authentic library behavior patterns
- Complex reader decision-making scenarios
- Realistic collection management challenges

### Learning Value
- Advanced command/query handler patterns
- Time-based event processing examples
- Multi-aggregate coordination techniques
- Production-ready domain modeling examples

## Future Extensions

- **Hold notifications**: Email/SMS simulation for reservation alerts
- **Priority reservations**: VIP readers, faculty holds, etc.  
- **Reservation fees**: Economic modeling of hold costs
- **Branch transfers**: Reserve books from other library locations
- **Digital reservations**: E-book and audiobook hold queues