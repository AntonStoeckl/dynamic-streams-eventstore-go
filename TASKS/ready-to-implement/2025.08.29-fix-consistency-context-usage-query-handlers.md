## Fix Consistency Context Usage in Query and Snapshot Handlers
- **Created**: 2025-08-29 12:45
- **Priority**: Medium
- **Objective**: Ensure proper consistency context usage in query handlers and snapshot wrappers

## 🎯 Problem Statement

During the observability abstraction implementation, I noticed potential inconsistencies in how query handlers and snapshot wrappers handle consistency contexts (`eventstore.WithStrongConsistency` vs `eventstore.WithEventualConsistency`).

The issue is that query handlers should typically use eventual consistency (can tolerate slightly stale data), but some may be inadvertently using strong consistency, which could impact performance unnecessarily.

## 📋 Investigation Required

### **1. Audit Current Usage**
- Review all query handler implementations
- Review all snapshot wrapper implementations  
- Check test files for consistency context usage
- Document current patterns vs intended patterns

### **2. Consistency Rules to Verify**

**Command Handlers** (already correct):
- ✅ **ALWAYS** use `eventstore.WithStrongConsistency(ctx)`
- ✅ Need to see their own writes immediately (read-check-write pattern)
- ✅ Already implemented correctly in refactored `lendbookcopytoreader`

**Query Handlers** (need verification):
- 🔍 **Should typically use** `eventstore.WithEventualConsistency(ctx)` 
- 🔍 Can tolerate slightly stale data for better performance
- 🔍 Exception: Real-time dashboards might need strong consistency

**Snapshot Wrappers** (need verification):
- 🔍 **Should typically use** `eventstore.WithEventualConsistency(ctx)`
- 🔍 Snapshots are performance optimizations, eventual consistency is usually fine
- 🔍 May need to inherit context from wrapped handler

### **3. Files to Investigate**

**Query Handlers:**
- `example/features/query/booksincirculation/query_handler.go`
- `example/features/query/bookslentbyreader/query_handler.go`
- `example/features/query/bookslentout/query_handler.go`
- `example/features/query/finishedlendings/query_handler.go`
- `example/features/query/registeredreaders/query_handler.go`
- `example/features/query/canceledreaders/query_handler.go`
- `example/features/query/removedbooks/query_handler.go`

**Snapshot Wrapper:**
- `example/shared/shell/snapshot/wrapper.go`

**Test Files:**
- All `*_test.go` files in query handler directories
- Check for consistency context patterns in test setup

## 🔧 Expected Fixes

### **If Issues Found:**

**Query Handlers:**
```go
// Current (if wrong):
func (h QueryHandler) Handle(ctx context.Context, query Query) (Result, error) {
    // Missing consistency context or wrong one
    storableEvents, maxSeq, err := h.eventStore.Query(ctx, filter)
    
// Fixed:
func (h QueryHandler) Handle(ctx context.Context, query Query) (Result, error) {
    // Use eventual consistency for query handlers (better performance)
    ctx = eventstore.WithEventualConsistency(ctx)
    storableEvents, maxSeq, err := h.eventStore.Query(ctx, filter)
```

**Snapshot Wrapper:**
```go
// Ensure snapshot operations use appropriate consistency
func (w *GenericSnapshotWrapper[Q, R]) executeIncrementalQuery(...) {
    // Should typically use eventual consistency unless specified otherwise
    ctx = eventstore.WithEventualConsistency(ctx)
    storableEvents, maxSeq, err := w.eventStore.Query(ctx, incrementalFilter)
```

**Test Files:**
```go
// Tests should explicitly set consistency context for clarity
func TestQueryHandler(t *testing.T) {
    // Use eventual consistency for query handlers (default behavior)
    ctx = eventstore.WithEventualConsistency(ctx)
    result, err := handler.Handle(ctx, query)
    
    // Only use strong consistency when testing that specific behavior
    ctx = eventstore.WithStrongConsistency(ctx) 
    result, err := handler.Handle(ctx, query) // Should still work
```

## 🎯 Success Criteria

1. **Consistency audit complete** - Document current vs intended usage
2. **Command handlers verified** - All use strong consistency (already done for lendbookcopytoreader)
3. **Query handlers consistent** - Use eventual consistency unless specifically needed
4. **Snapshot wrapper correct** - Uses appropriate consistency context
5. **Tests explicit** - Consistency context explicitly set in test files
6. **Performance impact** - Document any performance implications of changes
7. **Documentation updated** - Update any code comments about consistency expectations

## 📝 Implementation Notes

- This is primarily an **audit and fix** task, not a major architectural change
- Most changes will likely be small context additions: `ctx = eventstore.WithEventualConsistency(ctx)`
- Should verify if any query handlers actually NEED strong consistency for business reasons
- Test files should be explicit about consistency expectations
- Changes should maintain backward compatibility

## 🔍 Questions to Answer

1. Are all query handlers currently using the right consistency context?
2. Does the snapshot wrapper properly handle consistency contexts?
3. Are there any query handlers that legitimately need strong consistency?
4. Are test files explicit about consistency expectations?
5. What's the performance impact of any necessary changes?

## 🚀 Relationship to Previous Work

This builds on the observability abstraction work by ensuring that the clean, refactored handlers also follow correct consistency patterns. The `lendbookcopytoreader` command handler already correctly uses strong consistency, so this task focuses on the query side.