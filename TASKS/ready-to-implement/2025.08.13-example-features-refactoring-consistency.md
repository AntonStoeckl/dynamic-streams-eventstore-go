## Refactor Example Features for Consistency and Better Architecture
- **Created**: 2025-08-13 21:50
- **Priority**: Medium - Code consistency and architectural improvements
- **Objective**: Standardize example features with consistent patterns: failure reason constants, proper placement of BuildEventFilter functions in business logic files

### Current Inconsistencies
- **Failure Reasons**: Some features use hardcoded strings, others use constants (recent cancelreadercontract improvement)
- **Filter Placement**: BuildEventFilter functions are in command_handler.go/query_handler.go instead of business logic files
- **Architectural Misalignment**: Infrastructure layer (handlers) defines business data requirements instead of domain logic

### Refactoring Tasks

#### 1. Standardize Failure Reason Constants
**Objective**: All features should use descriptive constants for failure reasons instead of hardcoded strings
- **Pattern**: Follow `failureReasonOutstandingLoans` pattern from cancelreadercontract
- **Benefits**: Better maintainability, consistency, self-documenting code
- **Scope**: All features with error conditions

**Features to Update**:
- `lendbookcopytoreader/decide.go` - Multiple failure reasons (circulation, lending, book limits)
- `returnbookcopyfromreader/decide.go` - Circulation and lending failure reasons
- `removebookcopy/decide.go` - Circulation and lending failure reasons
- Any other features with hardcoded error messages

#### 2. Move BuildEventFilter to decide.go (Command Handlers)
**Objective**: Business logic should control its own event filtering requirements
- **Current Problem**: command_handler.go defines which events the business logic needs
- **Solution**: Move BuildEventFilter functions to decide.go files
- **Rationale**: Domain logic knows exactly which events it processes, so it should define which events it needs

**Architectural Benefits**:
- **Domain Logic Ownership**: Business logic controls its data dependencies
- **Reduced Coupling**: Command handlers become pure orchestration
- **Self-Contained Features**: Each feature slice controls its event filtering
- **DDD Alignment**: Domain logic defines its own data requirements

**Features to Update**: All command handlers with BuildEventFilter functions
- `addbookcopy/`
- `lendbookcopytoreader/` 
- `returnbookcopyfromreader/`
- `removebookcopy/`
- `registerreader/`
- `cancelreadercontract/` (already done correctly)

#### 3. Move BuildEventFilter to project.go (Query Handlers)  
**Objective**: Query projection logic should control its own event filtering requirements
- **Current Problem**: query_handler.go defines which events the projection logic needs
- **Solution**: Move BuildEventFilter functions to project.go files
- **Rationale**: Projection functions know exactly which events they process for state building

**Architectural Benefits**:
- **Projection Logic Ownership**: Query handlers control their event dependencies  
- **Consistency**: Same principle as decide functions - processors define their needs
- **Feature Independence**: Each query handler controls its own filtering logic
- **Locality of Decision**: Code that processes events also defines which events it needs

**Query Handlers to Update**: All features with query handlers and BuildEventFilter functions

### Implementation Approach

#### Phase 1: Failure Reason Constants
1. **Audit Current State**: Identify all hardcoded failure reason strings
2. **Create Constants**: Add descriptive constants following `failureReasonXxx` pattern
3. **Replace Hardcoded Strings**: Update all error decision calls to use constants
4. **Verify Consistency**: Ensure all failure reasons follow same naming convention

#### Phase 2: Command Handler Filter Movement
1. **Move BuildEventFilter Functions**: From command_handler.go to decide.go
2. **Update Import Dependencies**: Ensure decide.go files import eventstore package
3. **Update Command Handlers**: Modify to call decide.BuildEventFilter instead of local function
4. **Test Compilation**: Verify all command handlers compile correctly

#### Phase 3: Query Handler Filter Movement  
1. **Move BuildEventFilter Functions**: From query_handler.go to project.go
2. **Update Import Dependencies**: Ensure project.go files import eventstore package
3. **Update Query Handlers**: Modify to call project.BuildEventFilter instead of local function
4. **Test Compilation**: Verify all query handlers compile correctly

### File Structure Changes

**Before** (command handler example):
```
features/lendbookcopytoreader/
├── command_handler.go     // Contains BuildEventFilter
├── decide.go             // Business logic only
└── command.go
```

**After** (command handler example):
```
features/lendbookcopytoreader/
├── command_handler.go     // Pure orchestration
├── decide.go             // Business logic + BuildEventFilter  
└── command.go
```

**Before** (query handler example):
```
features/somequery/
├── query_handler.go       // Contains BuildEventFilter
├── project.go            // Projection logic only
└── query.go
```

**After** (query handler example):
```  
features/somequery/
├── query_handler.go       // Pure orchestration
├── project.go            // Projection logic + BuildEventFilter
└── query.go
```

### Success Criteria
- **Consistent Failure Messages**: All features use descriptive constants for error reasons
- **Proper Filter Placement**: BuildEventFilter functions located in business logic files
- **Architectural Alignment**: Domain/projection logic controls its own event filtering requirements  
- **No Functional Changes**: Refactoring maintains identical behavior
- **Clean Compilation**: All features compile without errors after refactoring
- **Handler Simplification**: Command/query handlers focus purely on orchestration

### Benefits
- **Better Architecture**: Domain logic controls its own data requirements
- **Improved Maintainability**: Constants make error messages easier to maintain
- **Feature Independence**: Each slice fully controls its event dependencies
- **Consistency**: All features follow same organizational patterns
- **Reduced Coupling**: Handlers don't need to know business event requirements

---