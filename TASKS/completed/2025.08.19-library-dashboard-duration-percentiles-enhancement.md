# üìä Library Dashboard Duration Percentiles Enhancement

- **Created**: 2025-08-19 10:30
- **Started**: 2025-08-19 10:35
- **Completed**: 2025-08-19 13:32
- **Priority**: Medium
- **Objective**: Add human-readable command and query duration percentile panels to Library Example Dashboard for better outlier detection and distribution insights

## üéØ Problem Statement
The current Library Example Dashboard only shows average durations using `rate(sum)/rate(count)` formula, which doesn't reveal:
- Performance outliers and spikes
- Distribution patterns across commands/queries
- When P99 latency degrades over time
- Which operations consistently have high tail latency

## ‚úÖ Implementation Complete

### üìä New Panels Added

#### 1. **Command Duration Percentiles (ms)** - Panel ID 24
- **Position**: Row 2.5 (y=11), left side (x=0, w=12)
- **Type**: Multi-line timeseries (human-readable, not heatmap)
- **Metrics**: 
  ```promql
  # P50 (median)
  histogram_quantile(0.50, rate(commandhandler_handle_duration_seconds_bucket{status="success"}[1m])) * 1000
  
  # P90 
  histogram_quantile(0.90, rate(commandhandler_handle_duration_seconds_bucket{status="success"}[1m])) * 1000
  
  # P95
  histogram_quantile(0.95, rate(commandhandler_handle_duration_seconds_bucket{status="success"}[1m])) * 1000
  
  # P99 (outliers)
  histogram_quantile(0.99, rate(commandhandler_handle_duration_seconds_bucket{status="success"}[1m])) * 1000
  ```
- **Legend Format**: `{{command_type}} P50`, `{{command_type}} P90`, etc.
- **Commands Tracked**: AddBookCopy, RegisterReader, LendBookCopy, ReturnBookCopy, RemoveBookCopy, CancelReaderContract

#### 2. **Query Duration Percentiles (ms)** - Panel ID 25
- **Position**: Row 2.5 (y=11), right side (x=12, w=12)
- **Type**: Multi-line timeseries
- **Metrics**: Same pattern as commands but using `queryhandler_handle_duration_seconds_bucket`
- **Legend Format**: `{{query_type}} P50`, `{{query_type}} P90`, etc.
- **Queries Tracked**: BooksInCirculation, BooksLentByReader, BooksLentOut, RegisteredReaders

### üèóÔ∏è Layout Updates
- **New panels positioned**: After existing average duration panels (Option 2 as requested)
- **All subsequent panels shifted down**: Updated y positions from y=10‚Üí17, y=16‚Üí23, y=21‚Üí29, etc.
- **Dashboard version bumped**: From 8 to 9
- **Grid layout maintained**: 12-column system preserved

## üé® Design Decisions
- **Multi-line timeseries over heatmaps**: User requested readable alternative to heatmaps
- **OpenTelemetry histogram buckets**: Leverages existing OTEL-compatible metrics from `shell.observability.go`
- **Millisecond units**: Human-readable scale with proper unit display
- **Classic color palette**: Consistent with existing dashboard styling
- **Clear legend format**: Easy to distinguish command types and percentiles

## üìã Benefits Delivered
- **Outlier Detection**: P99 spikes immediately visible when performance degrades
- **Distribution Insights**: Full performance story beyond just averages  
- **Trend Analysis**: Watch how percentiles evolve over time
- **Command Comparison**: Easy to see which commands have higher tail latency
- **Query Performance**: Identify data volume impact on query distribution

## üö® Critical Bug Fix Applied

### Problem Identified
- **Broken queries were missing proper histogram aggregation**
- All percentile panels showed constant 2000ms (timeout value) 
- No command-type differentiation (all identical values)
- P50=2000ms impossible with average=80ms

### Root Cause  
PromQL queries missing `sum by (command_type, le)` aggregation in `histogram_quantile()` calls.

### Fix Applied ‚úÖ
**Before (Broken):**
```promql
histogram_quantile(0.50, rate(commandhandler_handle_duration_seconds_bucket{status="success"}[1m])) * 1000
```

**After (Fixed):**
```promql  
histogram_quantile(0.50, sum by (command_type, le) (rate(commandhandler_handle_duration_seconds_bucket{status="success"}[1m]))) * 1000
```

**Key changes:**
- ‚úÖ Added `sum by (command_type, le)` for proper histogram bucket aggregation
- ‚úÖ Applied to all 8 percentile queries (4 commands + 4 queries) 
- ‚úÖ Dashboard version bumped to 10
- ‚úÖ Query percentiles use `query_type` instead of `command_type`

## üö® CRITICAL SECONDARY FIX: OpenTelemetry Histogram Buckets

### Problem Identified During Testing
After fixing the PromQL queries, discovered the **root cause**: OpenTelemetry histogram buckets were inappropriate for millisecond operations.

**Original buckets**: `[0.0, 5.0, 10.0, 25.0, 50.0, ...]` seconds (all operations fell in first bucket!)  
**Your operations**: 50-100ms commands, plus queries up to 60+ seconds

### Histogram Bucket Fix Applied ‚úÖ
**File**: `/eventstore/oteladapters/metrics_collector.go:154-157`
**Change**: Added explicit bucket configuration optimized for full operation range

**New buckets (seconds)**:
```go
[]float64{
    0.001, 0.005, 0.010, 0.020, 0.050, 0.100, 0.250, 0.500,
    1.000, 2.000, 5.000, 10.000, 20.000, 30.000, 45.000, 60.000, 120.000,
}
```

**Coverage**:
- ‚úÖ **1-20ms**: Future optimized commands  
- ‚úÖ **50-100ms**: Current command performance
- ‚úÖ **100ms-10s**: Query performance range
- ‚úÖ **10-60s**: Slow/complex queries
- ‚úÖ **60-120s**: Outlier detection

## üîç Review Items (Updated)
- [ ] **Restart observability stack** to apply new histogram buckets
- [ ] Percentiles show realistic values: P50 ~57ms, P90 ~80ms, P99 ~150ms for commands
- [ ] Query percentiles show appropriate values (variable based on complexity)  
- [ ] Each command type shows different percentile values
- [ ] Visual appearance and legend formatting works properly
- [ ] Performance insights are actionable for both commands and queries

## üé® Additional Visual Improvements

### Component Timing Breakdown Panel Consistency ‚úÖ
**Updated both panels (ID 22, 23) to match percentile panel styling:**
- **Height increased**: From 6‚Üí10 units for better readability
- **Auto-expanding legends**: Added `maxHeight: 200px` configuration
- **Consistent styling**: Matches percentile panels' visual appearance
- **Layout adjusted**: All subsequent panels shifted down by +4 units

### Legend Sorting Investigation üîç
**Problem**: Query Component Timing panel sorted differently than Command panel
- **Root cause identified**: Prometheus label ordering differences between metrics
- **Commands**: Labels ordered as `command_type, component, status` (correct grouping)
- **Queries**: Labels ordered as `component, query_type, status` (incorrect grouping)
- **Investigation method**: Direct Prometheus API queries revealed label ordering inconsistency
- **Attempted fix**: Modified Go label building functions (unsuccessful due to Go map ordering)
- **Resolution**: Accepted current behavior as simple solution is better than over-engineering

## üè• Infrastructure Improvements

### Observability Stack Health Checks ‚úÖ
**Added comprehensive health checks to all observability containers:**
- **Prometheus**: `/healthy` endpoint, 10s interval, 5 retries
- **Grafana**: `/api/health` endpoint, 10s interval, 5 retries  
- **Jaeger**: UI endpoint check, 10s interval, 5 retries
- **OTEL Collector**: No health check (distroless container limitations)
- **Dependency chains**: Proper startup ordering with `service_healthy` conditions
- **Consistent format**: Matches existing PostgreSQL health check patterns

## üõ†Ô∏è Technical Details
- **Files Modified**: 
  - `/testutil/observability/grafana/dashboards/library-example-dashboard.json` (v19)
  - `/testutil/observability/docker-compose.yml` (health checks)
  - `/eventstore/oteladapters/metrics_collector.go` (histogram buckets)
- **OpenTelemetry Compatibility**: Uses existing histogram metrics from command/query handlers
- **Prometheus Query Type**: `histogram_quantile()` function with `_bucket` suffix
- **Observability Integration**: Leverages `shell.RecordCommandMetrics()` and `shell.RecordQueryMetrics()`