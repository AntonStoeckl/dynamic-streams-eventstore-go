## Fix Return Book Concurrency Errors in Simulation
- **Started**: 2025-08-09
- **Completed**: 2025-08-09
- **Priority**: High - Eliminating false concurrency conflicts in simulation
- **Objective**: Fix the concurrency errors occurring when multiple workers try to return the same book

### Problem Analysis
**Issue**: Return book operations were generating concurrency errors: "concurrency error, no rows were affected"

**Root Cause**:
- Race condition between scenario selection and execution
- Multiple workers (out of 50) could select the same book-reader pair for return
- Time gap between checking available books and executing the return
- State only updated AFTER successful operations, not when selected

### Solution Implemented âœ…

Implemented a **reservation system** to prevent duplicate return attempts:

1. **Added Pending Operations Tracking**:
   - `pendingReturns` map in `SimulationState` tracks in-flight returns
   - Prevents selecting books already being returned

2. **Reservation Methods**:
   - `ReserveReturn()`: Atomically reserves a book for return
   - `ReleaseReturn()`: Releases reservation after operation
   - `GetAvailableBooksForReturn()`: Returns books not currently being returned

3. **Updated Scenario Selection**:
   - Only selects books that aren't already reserved
   - Checks pending returns before creating scenarios

4. **Execution-Time Reservation**:
   - Reserves book immediately before execution
   - Skips operation if reservation fails (no error)
   - Always releases reservation after operation (success or failure)

### Files Modified
- `example/simulation/cmd/state.go`: Added reservation tracking and methods
- `example/simulation/cmd/scenarios.go`: Updated return scenario selection logic
- `example/simulation/cmd/simulation.go`: Added reservation handling in execution

### Result
- **Before**: ~0.1% error rate with "concurrency error" messages
- **After**: Zero concurrency errors for return operations
- **Confirmed**: User verified the fix works correctly

### Key Insight
The EventStore was working correctly by detecting genuine concurrency conflicts. The fix prevents the simulation from creating these conflicts in the first place, making it more realistic and eliminating false errors.