## Add Duration Panels and Split Dashboards
- **Created**: 2025-08-12 15:30
- **Started**: 2025-08-12 15:30
- **Completed**: 2025-08-12 16:15
- **Priority**: Medium - Dashboard usability improvement
- **Objective**: Add 3 specific panels, extend observability system, and split single dashboard into two focused dashboards

### Merged Tasks
This task merges and supersedes:
- `2025.08.06-duration-metrics-investigation.md` - Duration metrics analysis need
- `2025.08.06-grafana-dashboard-panel-reordering.md` - Panel organization improvement need

### New Panels to Add
1. **Average SQL Insert Duration** 
   - Query: `rate(eventstore_append_duration_seconds_sum[1m]) / rate(eventstore_append_duration_seconds_count[1m]) * 1000`
   - Unit: milliseconds (ms)
   - Panel ID: 17

2. **Average SQL Select Duration**
   - Query: `rate(eventstore_query_duration_seconds_sum[1m]) / rate(eventstore_query_duration_seconds_count[1m]) * 1000`
   - Unit: milliseconds (ms)
   - Panel ID: 18

3. **Successful Query Operations/sec**
   - Query: `rate(queryhandler_handle_duration_seconds_count{status="success"}[1m])`
   - Unit: operations per second (ops)
   - Panel ID: 19
   - Note: This separates query handler operations from command handler operations

### Panel Organization Changes
- **SQL Operations Row**: Group panels 5, 6, 17, 18 (SQL Insert/Select Ops + Duration)
- **Command/Query Handler Row**: Group panels 9, 19, 10 (Command Ops + NEW Query Ops + Errors)

### Files to Modify
- `testutil/observability/grafana/dashboards/eventstore-dashboard.json` - Add new panels and adjust gridPos coordinates

### Implementation Details
- **COMPLETED**: Extended observability system with separate query handler metrics
- **COMPLETED**: Added `QueryHandlerDurationMetric = "queryhandler_handle_duration_seconds"` and related constants
- **COMPLETED**: Updated all query handlers to use query-specific functions (StartQuerySpan, RecordQueryMetrics, etc.)
- **COMPLETED**: Added panels 17-19 with appropriate gridPos coordinates
- **COMPLETED**: Reorganized panel layout with logical groupings
- Dashboard now has 19 total panels organized in logical rows

### Panel Layout (Final)
**Row 1 - EventStore Operations** (y=0): Panels 1-4 (Success/Error Append/Query)
**Row 2 - SQL Operations & Durations** (y=6): Panels 5, 6, 17, 18 (SQL Ops + NEW SQL Durations)  
**Row 3 - EventStore Durations** (y=12): Panels 7, 8 (EventStore Append/Query Durations)
**Row 4 - Command/Query Handlers** (y=18): Panels 9, 19, 10 (Command Ops + NEW Query Ops + Errors)
**Row 5+** - Context Management and Advanced Operations (y=24+)

### Success Criteria ✅
**Phase 1 - Duration Panels & Observability Extension:**
- ✅ Dashboard loads successfully with 19 total panels  
- ✅ SQL operations are logically grouped in one row (panels 5,6,17,18)
- ✅ Command/Query handler operations are logically grouped in one row (panels 9,19,10)
- ✅ New duration panels show realistic millisecond values (using * 1000 conversion)
- ✅ Query operations panel correctly separates from command operations (new `queryhandler` metrics)
- ✅ All panels use proper metrics with correct labels (`command_type` vs `query_type`)

**Phase 2 - Dashboard Splitting (COMPLETED):**
- ✅ Created new "Library Example Dashboard" with business logic panels
- ✅ Moved 9 panels (Commands, Queries, Conflicts, Cancellation, Timeouts) to new dashboard
- ✅ Kept 10 infrastructure/performance panels in EventStore Dashboard
- ✅ Both dashboards auto-provision and display correctly via existing provisioning config

**Dashboard Split Results:**
- **EventStore Dashboard**: 10 panels focusing on infrastructure/performance metrics
- **Library Example Dashboard**: 9 panels focusing on business logic/domain operations  
- **Files Created**: `library-example-dashboard.json` (new), `eventstore-dashboard.json` (cleaned)

### Testing Plan
1. Start observability stack: `cd testutil/observability && docker compose up -d`
2. Start PostgreSQL: `cd testutil/postgresengine && docker compose up -d postgres_benchmark`
3. Access dashboard: http://localhost:3000/d/eventstore-main-dashboard/eventstore-dashboard
4. Verify new panels display correctly
5. Run load generator to validate metrics: `DISABLE_OBSERVABILITY=false ./load-generator --rate=100`

---